{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "SESEmailIdentityManagement",
      "Effect": "Allow",
      "Action": [
        "ses:CreateEmailIdentity",
        "ses:DeleteEmailIdentity",
        "ses:GetEmailIdentity",
        "ses:PutEmailIdentityDkimAttributes",
        "ses:PutEmailIdentityMailFromAttributes",
        "ses:TagResource",
        "ses:UntagResource"
      ],
      "Resource": [
        "arn:aws:ses:eu-west-2:*:identity/*"
      ],
      "Description": "Required for creating and managing SES email identities with DKIM and MAIL FROM domain configuration"
    },
    {
      "Sid": "SESConfigurationSetManagement",
      "Effect": "Allow",
      "Action": [
        "ses:CreateConfigurationSet",
        "ses:DeleteConfigurationSet",
        "ses:DescribeConfigurationSet",
        "ses:PutConfigurationSetSendingOptions",
        "ses:PutConfigurationSetTrackingOptions",
        "ses:PutConfigurationSetReputationOptions"
      ],
      "Resource": [
        "arn:aws:ses:eu-west-2:*:configuration-set/dev-email-ses-config",
        "arn:aws:ses:eu-west-2:*:configuration-set/prod-email-ses-config"
      ],
      "Description": "Required for creating and managing environment-scoped SES configuration sets"
    },
    {
      "Sid": "SESEventDestinationManagement",
      "Effect": "Allow",
      "Action": [
        "ses:CreateConfigurationSetEventDestination",
        "ses:DeleteConfigurationSetEventDestination",
        "ses:DescribeConfigurationSetEventDestination",
        "ses:UpdateConfigurationSetEventDestination"
      ],
      "Resource": [
        "arn:aws:ses:eu-west-2:*:configuration-set/dev-email-ses-config",
        "arn:aws:ses:eu-west-2:*:configuration-set/prod-email-ses-config"
      ],
      "Description": "Required for configuring SES event destinations (SNS topics for delivery, bounce, complaint events)"
    },
    {
      "Sid": "Route53DNSRecordManagement",
      "Effect": "Allow",
      "Action": [
        "route53:ChangeResourceRecordSets",
        "route53:GetChange",
        "route53:ListResourceRecordSets"
      ],
      "Resource": [
        "arn:aws:route53:::hostedzone/*",
        "arn:aws:route53:::change/*"
      ],
      "Description": "Required for creating DKIM, SPF, and DMARC DNS records in Route53 hosted zone"
    },
    {
      "Sid": "Route53HostedZoneRead",
      "Effect": "Allow",
      "Action": [
        "route53:GetHostedZone",
        "route53:ListHostedZones",
        "route53:ListHostedZonesByName"
      ],
      "Resource": "*",
      "Description": "Required for looking up Route53 hosted zone for ponton.io domain"
    },
    {
      "Sid": "SNSTopicManagement",
      "Effect": "Allow",
      "Action": [
        "sns:CreateTopic",
        "sns:DeleteTopic",
        "sns:GetTopicAttributes",
        "sns:SetTopicAttributes",
        "sns:Subscribe",
        "sns:Unsubscribe",
        "sns:ListSubscriptionsByTopic",
        "sns:TagResource",
        "sns:UntagResource"
      ],
      "Resource": [
        "arn:aws:sns:eu-west-2:*:dev-email-ses-events",
        "arn:aws:sns:eu-west-2:*:prod-email-ses-events"
      ],
      "Description": "Required for creating SNS topics for SES event publishing and subscribing SQS queues"
    },
    {
      "Sid": "SQSQueueManagement",
      "Effect": "Allow",
      "Action": [
        "sqs:CreateQueue",
        "sqs:DeleteQueue",
        "sqs:GetQueueAttributes",
        "sqs:SetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:TagQueue",
        "sqs:UntagQueue"
      ],
      "Resource": [
        "arn:aws:sqs:eu-west-2:*:dev-email-ses-events",
        "arn:aws:sqs:eu-west-2:*:dev-email-ses-events-dlq",
        "arn:aws:sqs:eu-west-2:*:prod-email-ses-events",
        "arn:aws:sqs:eu-west-2:*:prod-email-ses-events-dlq"
      ],
      "Description": "Required for creating SQS queues (main queue and dead letter queue) for buffering SES events"
    },
    {
      "Sid": "KMSKeyManagement",
      "Effect": "Allow",
      "Action": [
        "kms:CreateKey",
        "kms:CreateAlias",
        "kms:DeleteAlias",
        "kms:DescribeKey",
        "kms:GetKeyPolicy",
        "kms:PutKeyPolicy",
        "kms:EnableKeyRotation",
        "kms:DisableKeyRotation",
        "kms:GetKeyRotationStatus",
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion",
        "kms:TagResource",
        "kms:UntagResource"
      ],
      "Resource": [
        "arn:aws:kms:eu-west-2:*:key/*",
        "arn:aws:kms:eu-west-2:*:alias/dev-email-ses-events-key",
        "arn:aws:kms:eu-west-2:*:alias/prod-email-ses-events-key"
      ],
      "Description": "Required for creating dedicated KMS keys for SES event encryption (separate from DynamoDB keys)"
    },
    {
      "Sid": "LambdaFunctionManagement",
      "Effect": "Allow",
      "Action": [
        "lambda:CreateFunction",
        "lambda:DeleteFunction",
        "lambda:GetFunction",
        "lambda:GetFunctionConfiguration",
        "lambda:UpdateFunctionCode",
        "lambda:UpdateFunctionConfiguration",
        "lambda:PublishVersion",
        "lambda:CreateAlias",
        "lambda:DeleteAlias",
        "lambda:UpdateAlias",
        "lambda:TagResource",
        "lambda:UntagResource",
        "lambda:AddPermission",
        "lambda:RemovePermission"
      ],
      "Resource": [
        "arn:aws:lambda:eu-west-2:*:function:dev-email-ses-event-processor",
        "arn:aws:lambda:eu-west-2:*:function:prod-email-ses-event-processor"
      ],
      "Description": "Required for creating and managing Lambda function for processing SES events from SQS queue"
    },
    {
      "Sid": "LambdaEventSourceMapping",
      "Effect": "Allow",
      "Action": [
        "lambda:CreateEventSourceMapping",
        "lambda:DeleteEventSourceMapping",
        "lambda:GetEventSourceMapping",
        "lambda:UpdateEventSourceMapping",
        "lambda:ListEventSourceMappings"
      ],
      "Resource": "*",
      "Description": "Required for creating event source mapping between SQS queue and Lambda function (resource-level permissions not supported)"
    },
    {
      "Sid": "IAMRoleManagement",
      "Effect": "Allow",
      "Action": [
        "iam:CreateRole",
        "iam:DeleteRole",
        "iam:GetRole",
        "iam:PassRole",
        "iam:AttachRolePolicy",
        "iam:DetachRolePolicy",
        "iam:PutRolePolicy",
        "iam:DeleteRolePolicy",
        "iam:GetRolePolicy",
        "iam:TagRole",
        "iam:UntagRole"
      ],
      "Resource": [
        "arn:aws:iam::*:role/dev-email-ses-*",
        "arn:aws:iam::*:role/prod-email-ses-*"
      ],
      "Description": "Required for creating IAM roles for Lambda execution with least privilege permissions"
    },
    {
      "Sid": "CloudWatchLogsManagement",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:DeleteLogGroup",
        "logs:DescribeLogGroups",
        "logs:PutRetentionPolicy",
        "logs:DeleteRetentionPolicy",
        "logs:TagLogGroup",
        "logs:UntagLogGroup"
      ],
      "Resource": [
        "arn:aws:logs:eu-west-2:*:log-group:/aws/lambda/dev-email-ses-event-processor",
        "arn:aws:logs:eu-west-2:*:log-group:/aws/lambda/dev-email-ses-event-processor:*",
        "arn:aws:logs:eu-west-2:*:log-group:/aws/lambda/prod-email-ses-event-processor",
        "arn:aws:logs:eu-west-2:*:log-group:/aws/lambda/prod-email-ses-event-processor:*"
      ],
      "Description": "Required for creating CloudWatch log groups for Lambda function with 180-day retention"
    },
    {
      "Sid": "CloudFormationManagement",
      "Effect": "Allow",
      "Action": [
        "cloudformation:CreateStack",
        "cloudformation:UpdateStack",
        "cloudformation:DeleteStack",
        "cloudformation:DescribeStacks",
        "cloudformation:DescribeStackEvents",
        "cloudformation:DescribeStackResources",
        "cloudformation:GetTemplate",
        "cloudformation:ValidateTemplate",
        "cloudformation:CreateChangeSet",
        "cloudformation:DescribeChangeSet",
        "cloudformation:ExecuteChangeSet",
        "cloudformation:DeleteChangeSet",
        "cloudformation:ListStacks"
      ],
      "Resource": [
        "arn:aws:cloudformation:eu-west-2:*:stack/dev-email-ses/*",
        "arn:aws:cloudformation:eu-west-2:*:stack/prod-email-ses/*"
      ],
      "Description": "Required for deploying and managing SES stack via CloudFormation"
    }
  ],
  "Notes": {
    "Purpose": "IAM permissions required for deploying Milestone 4: SES Configuration",
    "Deployment": "These permissions are needed by the IAM user/role that deploys the CDK stacks",
    "Security": "All permissions follow least privilege principle with resource-level restrictions where supported",
    "Dependencies": "Milestone 4 depends on Certificate Stack (Route53) and DynamoDB Stack (tables for event processing)",
    "Verification": "After deployment, verify SES identity, SNS topic, SQS queues, Lambda function, and event source mapping are created correctly"
  }
}
